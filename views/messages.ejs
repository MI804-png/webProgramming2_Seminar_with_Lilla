<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-5 fw-bold">
                    <i class="fas fa-comments text-primary"></i> Contact Messages
                </h1>
                <span class="badge bg-primary fs-6"><%= messages.length %> messages</span>
            </div>
            
            <% if (locals.isAdmin) { %>
            <div class="alert alert-info alert-custom">
                <i class="fas fa-crown"></i> <strong>Admin View:</strong> You can see all contact messages and manage their status.
            </div>
            <% } else { %>
            <div class="alert alert-success alert-custom">
                <i class="fas fa-user-check"></i> <strong>Registered User:</strong> You have access to view all customer inquiries.
            </div>
            <% } %>
        </div>
    </div>
    
    <% if (messages.length === 0) { %>
    <div class="row">
        <div class="col-12">
            <div class="card card-custom text-center">
                <div class="card-body py-5">
                    <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                    <h4>No Messages Yet</h4>
                    <p class="text-muted">No contact messages have been received yet.</p>
                    <a href="<%= basePath %>/contact" class="btn btn-primary btn-custom">
                        <i class="fas fa-plus"></i> Send First Message
                    </a>
                </div>
            </div>
        </div>
    </div>
    <% } else { %>
    
    <!-- Filter and Sort Options -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="searchMessages" placeholder="Search messages...">
            </div>
        </div>
        <div class="col-md-6">
            <select class="form-select" id="filterStatus">
                <option value="">All Status</option>
                <option value="new">New</option>
                <option value="read">Read</option>
                <option value="replied">Replied</option>
            </select>
        </div>
    </div>
    
    <!-- Messages List -->
    <div class="row" id="messagesList">
        <% messages.forEach((message, index) => { %>
        <div class="col-12 mb-4 message-item" data-status="<%= message.status %>" data-searchable="<%= message.name.toLowerCase() %> <%= message.email.toLowerCase() %> <%= message.subject.toLowerCase() %> <%= message.message.toLowerCase() %>">
            <div class="card card-custom shadow-sm">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-1">
                                    <i class="fas fa-user"></i> <%= message.name %>
                                    <%
                                    let statusClass = 'secondary';
                                    let statusText = 'PENDING';
                                    if (message.status) {
                                        if (message.status === 'new') { statusClass = 'success'; statusText = 'NEW'; }
                                        else if (message.status === 'read') { statusClass = 'primary'; statusText = 'READ'; }
                                        else if (message.status === 'replied') { statusClass = 'info'; statusText = 'REPLIED'; }
                                        else { statusClass = 'secondary'; statusText = message.status.toUpperCase(); }
                                    }
                                    %>
                                    <span class="badge bg-<%= statusClass %> ms-2"><%= statusText %></span>
                                </h5>
                            </div>
                            
                            <p class="text-muted mb-2">
                                <i class="fas fa-envelope"></i> 
                                <a href="mailto:<%= message.email %>" class="text-decoration-none"><%= message.email %></a>
                            </p>
                            
                            <% if (message.subject) { %>
                            <p class="text-muted mb-2">
                                <i class="fas fa-tag"></i> <strong>Subject:</strong> <%= message.subject %>
                            </p>
                            <% } %>
                            
                            <p class="card-text">
                                <%= message.message.length > 150 ? message.message.substring(0, 150) + '...' : message.message %>
                            </p>
                        </div>
                        
                        <div class="col-md-4 text-md-end">
                            <small class="text-muted d-block mb-2">
                                <i class="fas fa-calendar"></i> 
                                <%= new Date(message.created_at).toLocaleDateString() %>
                            </small>
                            <small class="text-muted d-block mb-3">
                                <i class="fas fa-clock"></i> 
                                <%= new Date(message.created_at).toLocaleTimeString() %>
                            </small>
                            
                            <div class="btn-group-vertical d-grid gap-2">
                                <a href="<%= basePath %>/messages/<%= message.id %>" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-eye"></i> View Details
                                </a>
                                
                                <% if (locals.isAdmin) { %>
                                <a href="<%= basePath %>/messages/<%= message.id %>/reply" class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-reply"></i> Reply
                                </a>
                                
                                <a href="<%= basePath %>/messages/<%= message.id %>/edit" class="btn btn-outline-warning btn-sm">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                                
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                        <i class="fas fa-cog"></i> Status
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="updateMessageStatus('<%= message.id %>', 'new'); return false;">
                                            <i class="fas fa-star text-success"></i> Mark as New
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="updateMessageStatus('<%= message.id %>', 'read'); return false;">
                                            <i class="fas fa-eye text-primary"></i> Mark as Read
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="updateMessageStatus('<%= message.id %>', 'replied'); return false;">
                                            <i class="fas fa-reply text-info"></i> Mark as Replied
                                        </a></li>
                                    </ul>
                                </div>
                                
                                <button type="button" class="btn btn-outline-danger btn-sm" 
                                        data-message-id="<%= message.id %>" 
                                        data-message-subject="<%= message.subject %>"
                                        onclick="confirmDeleteMessage(this)">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <% }); %>
    </div>
    <% } %>
    
    <!-- Back to Contact -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <a href="<%= basePath %>/contact" class="btn btn-primary btn-lg btn-custom">
                <i class="fas fa-plus"></i> Send New Message
            </a>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<% if (locals.isAdmin) { %>
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the message "<strong id="messageSubject"></strong>"?</p>
                <p class="text-danger mb-0"><i class="fas fa-warning"></i> This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete Message
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
<% } %>

<% if (locals.isAdmin) { %>
<script>
// Update message status (Admin only)
function updateMessageStatus(messageId, status) {
    const basePath = '<%= basePath %>';
    fetch(basePath + '/messages/' + messageId + '/status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to update status: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the status.');
    });
}

// Delete message confirmation
function confirmDeleteMessage(button) {
    const messageId = button.getAttribute('data-message-id');
    const messageSubject = button.getAttribute('data-message-subject');
    document.getElementById('messageSubject').textContent = messageSubject;
    document.getElementById('deleteForm').action = '<%= basePath %>/messages/' + messageId + '/delete';
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}
</script>
<% } %>

<script>
// Search functionality
document.getElementById('searchMessages').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const messages = document.querySelectorAll('.message-item');
    
    messages.forEach(message => {
        const searchableText = message.getAttribute('data-searchable');
        if (searchableText.includes(searchTerm)) {
            message.style.display = '';
        } else {
            message.style.display = 'none';
        }
    });
});

// Filter by status
document.getElementById('filterStatus').addEventListener('change', function() {
    const selectedStatus = this.value;
    const messages = document.querySelectorAll('.message-item');
    
    messages.forEach(message => {
        const messageStatus = message.getAttribute('data-status');
        if (!selectedStatus || messageStatus === selectedStatus) {
            message.style.display = '';
        } else {
            message.style.display = 'none';
        }
    });
});
</script>